<!DOCTYPE html>
<html>
  <title>Probleminstanser</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <link rel="stylesheet" href="css/w3.css">
  <script type="text/javascript" src="js/randutils.js"></script>
  <script type="text/javascript" src="js/cookies.js"></script>
  <script type="text/javascript" src="js/hashutils.js"></script>
  <script type="text/javascript" src="js/fileutils.js"></script>
  <script type="text/javascript" src="js/graphutils.js"></script>
  <script type="text/javascript" src="js/bintree.js"></script>
  <script type="text/javascript" src="js/pq.js"></script>
  <script type="text/javascript" src="js/sha1.js"></script>
  <script type="text/javascript" src="js/personnummer.js"></script>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lobster">
  <style>
    .w3-lobster {
	font-family: "Lobster", serif;
    }
  </style>
  <body class="w3-container w3-auto">
    <noscript>Du m&aring;ste ha javascript p&aring;slaget i din browser f&ouml;r att kunna ta del av uppgifterna.</noscript>
    <script>
      const invalidPNrText = "Invalid personnummer.";
      const validPNrText = "Ok!";
      var urlParams = new URLSearchParams(window.location.search);
      
      function validate(fld) {
	  let x = document.getElementById("statusIndicator");
	  let y = document.getElementById("personnummerHeader");
	  x.className = "w3-container w3-lobster";
	  y.className = "w3-xlarge w3-lobster";
	  if(personnummerValid(fld)) {
	      x.className += " w3-green";
	      y.innerHTML = validPNrText;
	      setCookie("personnummer", fld, 1);
	      generateProblem(fld);
	  } else {
	      x.className += " w3-red";
	      y.innerHTML = invalidPNrText;
	  }
      }

      function getParamOrDefault(rng, paramName, d) {
	  if(urlParams.has(paramName)) {
	      let v = parseInt(urlParams.get(paramName));
	      if(v != NaN) {
		  rng.mixString(paramName + v);
		  return v;
	      }
	  }
	  return d;
      }

      function filterPersonnummer(pnr) {
	  return pnr.replace("-", "");
      }

      function generateProblem(pnr) {
	  const problemType = urlParams.get('problemType');
	  rng = new RNG(filterPersonnummer(pnr), urlParams.get('courseCode') + urlParams.get('date'));
	  let problemText = "Unknown problemType";
	  let skew = getParamOrDefault(rng, 'skew', 0) / 100.0;
	  let minV = getParamOrDefault(rng, 'min', 10);
	  let maxV = getParamOrDefault(rng, 'max', 100);
	  let sizeV = getParamOrDefault(rng, 'size', 10);
	  let capacityV = getParamOrDefault(rng, 'capacity', 0);
	  let disjoint = getParamOrDefault(rng, 'disjoint', 0);
	  if(problemType === null || problemType === 'randomList') {
	      problemText = rng.relabelInts(rng.intList(sizeV, skew), minV, maxV).join(", ");
	  } else if(problemType === 'pqAddRemove') {
	      let pq = new PQ(rng, skew, sizeV);
	      let A = pq.ps(3);
	      problemText = "Ins&auml;ttningsordning: " + A[0].join(", ") + "<br><br>" +
		  "a) " + A[1].join(", ") + "<br><br>" +
		  "b) " + A[2].join(", ") + "<br><br>" +
		  "c) " + A[3].join(", ") + "<br><br>";
	  } else if(problemType === 'hashKeys') {
	      let h = ht(rng, sizeV, skew, minV, maxV, 1.1, 1.3);
	      let m = h[1];
	      let k = h[0];
	      let hv = h[2].join(", ");
	      problemText = "m = " + m + ", k = " + k + "<br>" + hv;
	  } else if(problemType === 'hashKeysOpen') {
	      let h = ht2(rng, capacityV, sizeV, skew, minV, maxV, 1.1, 1.3);
	      let m = h[1];
	      let hv = h[2].join(", ");
	      //problemText = "m = " + capacityV + "<br>" + hv;
	      problemText = hv;
	  } else if(problemType == 'binTree') {
	      getTree(rng, sizeV, (tree) => {
		  y.innerHTML = tree;
	      });
	  } else if(problemType == 'lrss') {
	      let s1 = rng.relabelInts(rng.intList(sizeV, skew), 10, 30);
	      let s2 = rng.relabelInts(rng.intList(sizeV, skew * 2), 10, 30);
	      problemText = "S1: {" + s1.join(", ") + "}<br>" +
		  "S2: {" + s2.join(", ") + "}";
	  } else if(problemType == 'binTree2') {
	      getTree2(rng, (tree) => {
		  y.innerHTML = tree;
	      });
	  } else if(problemType == 'graph') {
	      getGraph(rng, sizeV, (graph) => {
		  y.innerHTML = graph;
	      });
	  } else if(problemType == 'graph2') {
	      let pairs = ["AG", "AH", "AF", "BE", "BF", "CE", "DH",
			   "DG", "EG", "EH"];
	      let pIdx = rng.nextInt(pairs.length);
	      let R = rng.nextInt(10) + 15;
	      let startNode = pairs[pIdx].substr(0, 1);
	      let endNode = pairs[pIdx].substr(1, 1);
	      problemText = "R: " + R + "<br>" +
		  "START: " + startNode + "<br>" + 
		  "SLUT: " + endNode;
	  } else if(problemType == 'letterPerm') {
	      var arr = [];
	      let baseChar = 'A'.charCodeAt(0);
	      for(var i = 0; i < sizeV; i++) {
		  arr[i] = String.fromCharCode(baseChar + i);
	      }
	      rng.shuffle(arr);
	      problemText = arr.join(", ");
	  } else if(problemType == 'digraph') {
	      let w = getDigraphWeights(rng, sizeV, 20, 30, 3, 20, disjoint);
	      w.sort((a,b) => a-b);
	      problemText = w.join(", ");
	  } else {
  	      console.log("Randomlist!");
	  }
	  var y = document.getElementById("hash");
	  y.innerHTML = problemText;
      }

      document.addEventListener('DOMContentLoaded', function() {
	  let v = "";
	  let y = document.getElementById("personnummer");
	  if(urlParams.has('personnummer')) {
	      y.value = urlParams.get('personnummer');
	      v = y.value;
	      setCookie("personnummer", v, 1);
	  } else if(getCookie("personnummer").length > 0) {
	      v = getCookie("personnummer");
	      y.value = v;
	  }
	  validate(v);
//	  console.log("Personnummer: " + v);
	  function handleForm(event) {
//	      console.log(event);
	      event.preventDefault();
	  }
	  y.addEventListener('submit', handleForm);
	  document.getElementById("personnummerForm").addEventListener('submit', handleForm);
      }, false);
      
    </script>

    <form class="w3-container" id="personnummerForm">
      <p>
	<label>Your personnummer, as YYYYMMDD-XXXX:</label>
	<input id="personnummer" class="w3-input" type="text" name="personnummer"
	       onkeyup="validate(this.value)" autofocus></p>
    </form>
    
    <div class="w3-container w3-blue w3-lobster" id="statusIndicator">
      <h2 id="personnummerHeader"> </h2>
    </div>
    <p>
    <p>
    <div class="w3-card w3-white w3-xlarge" id="hash">
    </div>
  </body>
</html>
